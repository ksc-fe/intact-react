(function(e,t){typeof exports==="object"&&typeof module!=="undefined"?module.exports=t(require("react"),require("intact/dist"),require("react-dom")):typeof define==="function"&&define.amd?define(["react","intact/dist","react-dom"],t):e.Intact=t(e.React,e.Intact,e.ReactDOM)})(this,function(e,t,r){"use strict";e=e&&e.hasOwnProperty("default")?e["default"]:e;t=t&&t.hasOwnProperty("default")?t["default"]:t;r=r&&r.hasOwnProperty("default")?r["default"]:r;var n=function(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}};var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}return function(t,r,n){if(r)e(t.prototype,r);if(n)e(t,n);return t}}();var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r){if(Object.prototype.hasOwnProperty.call(r,n)){e[n]=r[n]}}}return e};var a=function(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof t)}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:false,writable:true,configurable:true}});if(t)Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t};var s=function(e,t){if(!e){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return t&&(typeof t==="object"||typeof t==="function")?t:e};var u=function(){function e(t){var r=this;n(this,e);this.resolved=false;this.callbacks=[];t.call(this,function(){return r.resolve()})}e.prototype.resolve=function e(){this.resolved=true;var t=void 0;while(t=this.callbacks.shift()){t()}};e.prototype.then=function e(t){this.callbacks.push(t);if(this.resolved){this.resolve()}};return e}();u.all=function(e){var t=e.length;var r=0;var n=void 0;var o=false;var i=false;e.forEach(function(a){a.then(function(){r++;console.log(t,r,e.length,e);if(e.length===r){o=true;if(i)debugger;if(n){i=true;n()}}})});var a=e.push;e.push=function(s){if(!i){s.then(function(){r++;console.log(t,r,e.length,e);if(e.length===r){o=true;if(i)debugger;if(n){i=true;n()}}})}a.call(e,s)};return{then:function e(r){n=r;if(!t||o){n()}}}};var c=function(){function e(){n(this,e)}e.prototype.init=function e(t,r){this.destroyed=true;this.placeholder=document.createComment(" react-mount-point-unstable ");this._render(r);return this.placeholder};e.prototype.update=function e(t,r){this._render(r);return this.placeholder};e.prototype.destroy=function e(){var t=this.placeholder;t._unmount=function(){r.render(null,t,function(){t.parentNode.removeChild(t)})}};e.prototype._render=function e(t){var n=this;var o=this._addProps(t);console.log("_start",o.type);var i=t.props.parentRef.instance;if(i){if(!i._reactInternalFiber){i=i.get("parentRef").instance}}else{var a=t.parentVNode;while(a){var s=a.children;if(s&&s._reactInternalFiber!==undefined){i=s;break}a=a.parentVNode}}var c=new u(function(e){if(i&&i._reactInternalFiber!==undefined){r.unstable_renderSubtreeIntoContainer(i,o,n.placeholder,function(){console.log("_end",o.type);e()})}else{r.render(o,n.placeholder,function(){console.log("_end",o.type);e()})}});i.promises.push(c)};e.prototype._addProps=function e(t){this.vdt={vNode:t};var r=t.props;var n=void 0;var o=void 0;for(var a in r){if(a==="reactVNode"||a==="parentRef")continue;if(!n){n=i({},r.reactVNode);o=n.props=i({},n.props)}var s=r[a];if(a.substr(0,3)==="ev-"){o[l[a]]=s}else{o[a]=s}}return n||r.reactVNode};return e}();var l={"ev-click":"onClick","ev-mouseenter":"onMouseEnter","ev-mouseleave":"onMouseLeave"};var p=e.createElement;function f(e,t,r){var n=e.$$cid==="IntactReact";var o=e.propTypes;if(n&&o){e.propTypes=undefined}var i=p.apply(this,arguments);if(n&&o){e.propTypes=o}return i}e.createElement=f;var h=t.Vdt.miss;var d=h.h;var v=h.VNode;var g=t.utils;var _=g.isFunction;var y=g.isArray;var m=g.isStringOrNumber;var b=g.set;var C=g.get;function N(e,t){if(e==null)return e;if(m(e))return e;if(e instanceof v){if(e.tag===c){e.props.parentRef=t}return e}if(e.type&&e.type.$$cid==="IntactReact"){return d(e.type,x(i({},e.props,{parentRef:t}),{_context:e._owner&&e._owner.stateNode},t,e.key),null,null,e.key,e.ref)}return d(c,{reactVNode:e,parentRef:t})}function R(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(y(e)){return e.map(function(e){return N(e,t)})}return N(e,t)}function x(e,t,r,n){if(!e)return;var o={};var i=o._blocks={};var a=void 0;for(var s in e){if(s==="children"){o.children=R(e.children,r)}else if(a=M(s)){o[a]=e[s]}else if(s.substring(0,2)==="b-"){i[s.substring(2)]=w(e[s])}else{o[s]=e[s]}}o._context=Q(t);if(n!=null){o.key=n}return o}function Q(e){var t=e._context;return{data:{get:function e(r){if(r!=null){return C(t.state,r)}else{return t.state}},set:function e(r,n){var o=i({},t.state);b(o,r,n);t.setState(o)}}}}function w(e){if(_(e)){return function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++){n[o-1]=arguments[o]}return R(e.apply(this,n),{instance:this.data})}}else{return function(){return R(e,{instance:this.data})}}}function M(e){var t=e[0],r=e[1],n=e[2];var o=void 0;if(t==="o"&&r==="n"){if(n==="$"){return"ev-$"+e.substring(3).replace(/\-/g,":")}else if((o=n.charCodeAt(0))&&o>=65&&o<=90){return"ev-"+e.substring(2).toLowerCase()}}}var T=t.utils;var O=T.isStringOrNumber;var V=T.isArray;function k(e){function t(t,r){if(r){var n=e(x(t,r,{}),true);if(V(n)){return n.map(function(e){return I(e)})}return I(n)}else{return e(t)}}return t}function I(e){if(O(e)){return e}else if(e){return f(e.tag,e.props,e.props.children||e.children)}}var E=t.utils;var j=E.noop;var P=E.isArray;var A=E.isObject;var $=t.Vdt.miss.h;var S=void 0;var F=function(t){a(r,t);function r(e,o){n(this,r);if(o){var i={};var a=x(e,o,i);var u=s(this,t.call(this,a));i.instance=u;console.log("context",o);u.promises=o.promises||[];u.mountedQueue=o.mountedQueue;u.vNode=$(u.constructor,a);u.vNode.children=u;u._props=u.props;delete u.props;u._isReact=true;S=u}else{var u=s(this,t.call(this,e))}return s(u)}r.prototype.getChildContext=function e(){return{parent:this,promises:this.promises,mountedQueue:this.mountedQueue}};r.prototype.get=function e(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++){n[o]=arguments[o]}if(this._isReact){var i;var a=this.props;this.props=this._props;var s=(i=t.prototype.get).call.apply(i,[this].concat(n));this.props=a;return s}else{var u;return(u=t.prototype.get).call.apply(u,[this].concat(n))}};r.prototype.set=function e(){for(var r=arguments.length,n=Array(r),o=0;o<r;o++){n[o]=arguments[o]}if(this._isReact){var i;var a=this.props;this.props=this._props;var s=(i=t.prototype.set).call.apply(i,[this].concat(n));this.props=a;return s}else{var u;return(u=t.prototype.set).call.apply(u,[this].concat(n))}};r.prototype.init=function e(r,n){var o=this;var e=function e(){console.log("start",o);var a=n.props.parentRef;var s=a&&a.instance;var u=void 0;if(s){var c=o;u=s.getChildContext;s.getChildContext=function(){var e=u.call(this);return i({},e,{parent:c})}}var l=t.prototype.init.call(o,r,n);console.log("end_start",o);if(s){s.getChildContext=u}return l};if(!this._isReact)return e();return e()};r.prototype.update=function e(r,n,o){var a=this;var e=function e(){console.log("start",a);var s=n&&n.props.parentRef;var u=s&&s.instance;var c=void 0;if(u){var l=a;c=u.getChildContext;u.getChildContext=function(){var e=c.call(this);return i({},e,{parent:l})}}var p=t.prototype.update.call(a,r,n,o);console.log("end_start",a);if(u){u.getChildContext=c}return p};if(!this._isReact)return e();var s=this._shouldTrigger;this.__initMountedQueue();var u=e();this.__triggerMountedQueue();this._shouldTrigger=s;return u};r.prototype.componentDidMount=function e(){var t=this;var r=this._shouldTrigger;this.__initMountedQueue();this.inited=true;this.parentVNode=this.vNode.parentVNode=this.context.parent&&this.context.parent.vNode;var n=this.init(null,this.vNode);var o=this._placeholder.parentElement;o.replaceChild(n,this._placeholder);this._placeholder._realElement=n;if(!o._hasRewrite){var i=o.removeChild;o.removeChild=function(e){i.call(this,e._realElement||e)};o._hasRewrite=true}this.mountedQueue.push(function(){t.mount()});this.__triggerMountedQueue();this._shouldTrigger=r};r.prototype.componentWillUnmount=function e(){this.destroy()};r.prototype.componentDidUpdate=function e(){var t=this._shouldTrigger;this.__initMountedQueue();var r=$(this.constructor,x(this.props,this.context,{instance:this}));var n=this.vNode;r.children=this;this.vNode=r;this.parentVNode=r.parentVNode=this.context.parent&&this.context.parent.vNode;this.update(n,r);this.__triggerMountedQueue();this._shouldTrigger=t};r.prototype.__ref=function e(t){this._placeholder=t};r.prototype.render=function t(){console.log("render",this);return e.createElement("i",{ref:this.__ref})};r.prototype.__initMountedQueue=function e(){this._shouldTrigger=false;if(!this.mountedQueue||this.mountedQueue.done){this._shouldTrigger=true;this._initMountedQueue();console.log("_initMountedQueue",this)}else{}};r.prototype.__triggerMountedQueue=function e(){var t=this;if(this._shouldTrigger){u.all(this.promises).then(function(){t._triggerMountedQueue();console.log("_triggerMountedQueue",t)});this._shouldTrigger=false}};r.prototype.__pushActiveInstance=function e(){var t=this._activeReactInstance;this._activeReactInstance=S};o(r,[{key:"isMounted",get:function e(){return this.mounted}}]);return r}(t);F.functionalWrapper=k;F.normalize=R;F.$$cid="IntactReact";F.prototype.isReactComponent={};F.contextTypes={_context:j,parent:j,promises:j,mountedQueue:j};F.childContextTypes={parent:j,promises:j,mountedQueue:j};return F});